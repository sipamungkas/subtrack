# Partytown Analytics Integration Design

## Overview

Add Google Analytics (GA4) and Umami (self-hosted) analytics to the Subnudge frontend using Partytown to offload script execution to a web worker, keeping the main thread free for optimal performance.

## Goals

- Run analytics scripts off the main thread using Partytown
- Zero main thread impact from analytics JavaScript execution
- Production-only: no analytics in development mode
- Hardcoded tracking IDs (single environment)

## Architecture

```
frontend/
├── vite.config.ts        # Add Partytown plugin + script injection
├── package.json          # Add @builder.io/partytown dependency
└── public/
    └── ~partytown/       # Auto-generated by Vite plugin at build time
```

### How It Works

1. **Build time**: Vite plugin copies Partytown library files to `dist/~partytown/`
2. **Runtime (production only)**:
   - Partytown snippet initializes in `<head>`, creates a web worker
   - GA4 and Umami scripts marked with `type="text/partytown"`
   - Partytown intercepts these scripts and runs them in the worker thread
   - Analytics calls proxied from worker → main thread → network
3. **Development mode**: Scripts not injected (via `transformIndexHtml` hook)

## Implementation

### 1. Install Dependency

```bash
cd frontend && npm install @builder.io/partytown
```

### 2. Update vite.config.ts

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import path from 'path'
import { partytownVite } from '@builder.io/partytown/utils'

export default defineConfig(({ mode }) => ({
  plugins: [
    react(),
    tailwindcss(),
    partytownVite({
      dest: path.resolve(__dirname, 'dist', '~partytown'),
    }),
    {
      name: 'inject-partytown-analytics',
      transformIndexHtml(html, ctx) {
        if (ctx.server) return html // Skip in dev mode

        return html.replace(
          '</head>',
          `
    <!-- Partytown config + snippet -->
    <script>
      partytown = {
        forward: ['dataLayer.push', 'gtag'],
      };
    </script>
    <script src="/~partytown/partytown.js"></script>

    <!-- Google Analytics (GA4) -->
    <script type="text/partytown" src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script type="text/partytown">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <!-- Umami Analytics -->
    <script type="text/partytown" defer src="https://your-umami-domain.com/script.js" data-website-id="your-website-id"></script>
  </head>`
        )
      },
    },
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
      },
    },
  },
}))
```

### 3. Tracking IDs (Configured)

- GA4 Measurement ID: `G-2ZZ3NG9SMM`
- Umami script URL: `https://umami.awans.id/script.js`
- Umami website ID: `f510a727-c8bb-410b-a3f7-fa1f0a8e184b`

## Testing

- `npm run dev` → No analytics scripts in page source (check DevTools)
- `npm run build && npm run preview` → Scripts present, running in Partytown worker
- Check browser DevTools Network tab for analytics requests
- Verify in GA4 Realtime and Umami dashboard

## Dependencies

- `@builder.io/partytown` - Partytown library and Vite plugin
